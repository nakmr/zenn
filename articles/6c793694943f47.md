---
title: "Alchemyã®Account Kitã§Account Abstractionã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ‘›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Alchemy", "AccountAbstraction", "React"]
published: false
---

# ã¯ã˜ã‚ã«

Account Abstractionã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ã•ã¾ã–ã¾ãªã‚¤ãƒ³ãƒ•ãƒ©ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
ä»Šå›ã¯Web3ã‚¤ãƒ³ãƒ•ãƒ©ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¤§æ‰‹ã§ã‚ã‚‹AlchemyãŒæä¾›ã—ã¦ã„ã‚‹Account Kitã‚’ä½¿ã£ã¦ã€Account Abstractionã‚’å®Ÿç¾ã—ã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š
- å…¬å¼ Getting Started
  - https://accountkit.alchemy.com/getting-started.html
- Alchemyã«ã‚ˆã‚‹Account Kitå®Ÿè£…ä¾‹
  - https://github.com/alchemyplatform/creating-light-smart-account-and-sending-user-ops

## æƒ³å®šèª­è€…

- Alchemyã®Account Kitã‚’è§¦ã£ã¦ã¿ãŸã„äºº
- å…¬å¼ã‚¬ã‚¤ãƒ‰ã«æ²¿ã£ã¦è§¦ã£ã¦ã¿ãŸã‘ã©ã€ã†ã¾ãå‹•ä½œã—ãªãã¦ã‚°ã‚°ã£ã¦ãŸã©ã‚Šç€ã„ãŸäºº


# å‰æ
## å®Ÿè¡Œç’°å¢ƒ

- React: 18.2.0
- Next: 13.5.6

## äº‹å‰æº–å‚™

Alchemyã®API Keyä½œæˆã¨ã€Account Kitç”¨ã®Gas Manager Policyã®ä½œæˆãŒå¿…è¦ã§ã™ã€‚

Gas Manager Policyã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®Gasä»£ã‚’è‚©ä»£ã‚ã‚Šã™ã‚‹ã«ã‚ãŸã£ã¦ã®ãƒãƒªã‚·ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

[Dashbord](https://dashboard.alchemy.com/)ã‹ã‚‰ã€Account Abstraction > Gas Manager ã‚’é¸æŠã—ã¦ã€ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚å…¬å¼ã‚¬ã‚¤ãƒ‰ã¯[ã“ã¡ã‚‰](https://docs.alchemy.com/docs/setup-a-gas-manager-policy)ã€‚

# å®Ÿè£…

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¿½åŠ 

ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```bash
pnpm install @alchemy/aa-alchemy @alchemy/aa-accounts @alchemy/aa-core viem
```

`package.json`ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚

```json
"dependencies": {
    "@alchemy/aa-accounts": "^0.2.0",
    "@alchemy/aa-alchemy": "^0.2.0",
    "@alchemy/aa-core": "^0.2.0",
    "next": "12.1.2",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "viem": "^1.18.6"   
}
```

### Providerã‚’å–å¾—ã™ã‚‹
`Provider`ã¯AlchemyãŒæä¾›ã—ã¦ã„ã‚‹RPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æ¥ç¶šã‚’æä¾›ã™ã‚‹ã¨åŒæ™‚ã«ã€Bundlerã‹ã‚‰å—ã‘å–ã£ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨¼ãŠã‚ˆã³UserOperationã®å®Ÿè¡Œã‚’è¡Œã†Entry Pointã®ã‚¢ãƒ‰ãƒ¬ã‚¹æƒ…å ±ã‚’æŒã¡ã¾ã™ã€‚

> What is an EntryPoint?
> A singleton smart contract that receives transactions from Bundlers, then verifies and executes UserOperations.
> https://www.alchemy.com/learn/account-abstraction

```typescript
import { LightSmartContractAccount, getDefaultLightAccountFactoryAddress } from "@alchemy/aa-accounts"
import { AlchemyProvider } from "@alchemy/aa-alchemy"
import { LocalAccountSigner, type SmartAccountSigner } from "@alchemy/aa-core"
import { sepolia } from "viem/chains"

export const getProvider = async () => {
  const chain = sepolia
  // Private Keyã¯ 0x ä»˜ãã§æ¸¡ã™ã“ã¨ã«æ³¨æ„ã€‚
  const PRIVATE_KEY = process.env.LIGHT_ACCOUNT_OWNER_PRIVATE_KEY as `0x${string}`
  const ALCHEMY_API_KEY = process.env.ALCHEMY_API_KEY_SEPOLIA

  // ã“ã“ã§ã¯AlchemyãŒæä¾›ã—ã¦ã„ã‚‹Entry Pointã‚’åˆ©ç”¨ã€‚0x ä»˜ãã§æ¸¡ã™ã“ã¨ã«æ³¨æ„ã€‚
  // ï¼ˆå‚è€ƒï¼‰https://docs.alchemy.com/reference/eth-supportedentrypoints
  const ENTRYPOINT_ADDRESS = "5FF137D4b0FDCD49DcA30c7CF57E578a026d2789" as `0x${string}`

  const eoaSigner: SmartAccountSigner = LocalAccountSigner.privateKeyToAccountSigner(PRIVATE_KEY)

  const provider = new AlchemyProvider({
    rpcUrl: `https://eth-sepolia.g.alchemy.com/v2/${ALCHEMY_API_KEY}`,
    chain,
    entryPointAddress: ENTRYPOINT_ADDRESS,
  }).connect(
    (rpcClient) =>
      // Entry Pointã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã£ãŸLight Smart Contract Addressã‚’ç”Ÿæˆã€‚
      new LightSmartContractAccount({
        entryPointAddress: ENTRYPOINT_ADDRESS,
        chain: rpcClient.chain,
        owner: eoaSigner,
        factoryAddress: getDefaultLightAccountFactoryAddress(rpcClient.chain),
        rpcClient,
      })
  )

  return provider
}
```

## UserOperationã‚’é€ã‚‹

0.0001 Ethã‚’æŒ‡å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã™ã‚‹UserOperationã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import { SendUserOperationResult } from "@alchemy/aa-core"
import { parseEther } from "viem"
import { getProvider } from "./getProvider"

export const sendUserOperation = async () => {
  const provider = await getProvider()
  provider.getAddress().then((address: string) => console.log(address))

  const targetAddress = "é€ä¿¡å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹" as `0x${string}`
  const amountToSend: bigint = parseEther("0.0001")

  const result: SendUserOperationResult = await provider.sendUserOperation({
    target: targetAddress,
    data: "0x",
    value: amountToSend,
  })

  console.log("User operation result: ", result)
  console.log("\nWaiting for the user operation to be included in a mined transaction...")

  const txHash = await provider.waitForUserOperationTransaction(result.hash as `0x${string}`)
  console.log("\nTransaction hash: ", txHash)

  const userOpReceipt = await provider.getUserOperationReceipt(result.hash as `0x${string}`)
  console.log("\nUser operation receipt: ", userOpReceipt)

  const txReceipt = await provider.rpcClient.waitForTransactionReceipt({
    hash: txHash,
  })
  console.log("\nTransaction receipt: ", txReceipt)
}
```

`sendUserOperation()`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«UserOperationã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚


